<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GearGuard | Ultimate Maintenance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-pure: #000000;
            --bg-sidebar: #050505;
            --bg-card: #0a0a0a;
            --bg-header: rgba(0, 0, 0, 0.8);
            --border-main: #333333;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --bg-alt: #171717;
            --logo-bg: #ffffff;
            --logo-text: #000000;
        }

        :root.light-mode {
            --bg-pure: #ffffff;
            --bg-sidebar: #fafafa;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.9);
            --border-main: #e4e4e7;
            --text-primary: #000000;
            --text-secondary: #52525b;
            --bg-alt: #f4f4f5;
            --logo-bg: #000000;
            --logo-text: #ffffff;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-pure);
            color: var(--text-primary);
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s ease;
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border-main);
            color: var(--text-primary);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .sidebar-link.active {
            background: var(--bg-alt);
            border-left: 3px solid var(--text-primary);
            color: var(--text-primary) !important;
        }

        .sidebar-link {
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .sidebar-link:hover {
            color: var(--text-primary);
            background: var(--bg-alt);
        }

        header {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border-main);
            backdrop-filter: blur(20px);
        }

        aside {
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-main);
        }

        input,
        select,
        textarea {
            background-color: var(--bg-alt) !important;
            border: 1px solid var(--border-main) !important;
            color: var(--text-primary) !important;
        }

        input:focus {
            border-color: var(--text-primary) !important;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-pure);
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }
    </style>
    {% block head %}{% endblock %}
</head>

<body class="h-full">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 flex flex-col">
            <div class="p-8">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-[var(--logo-bg)] text-[var(--logo-text)] rounded-lg flex items-center justify-center font-black">
                        GG
                    </div>
                    <h1 class="text-xl font-black tracking-tighter uppercase italic">GearGuard</h1>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 mt-4">
                <a href="/"
                    class="sidebar-link {{ 'active' if request.endpoint == 'dashboard' }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-chart-pie text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Dashboard</span>
                </a>
                <a href="/equipment"
                    class="sidebar-link {{ 'active' if request.endpoint in ['equipment_list', 'equipment_detail', 'new_equipment'] }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-tools text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Inventory</span>
                </a>
                <a href="/kanban"
                    class="sidebar-link {{ 'active' if request.endpoint == 'kanban' }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-columns text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Workflows</span>
                </a>
                <a href="/calendar"
                    class="sidebar-link {{ 'active' if request.endpoint == 'calendar' }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-calendar-alt text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Timeline</span>
                </a>
                <a href="/categories"
                    class="sidebar-link {{ 'active' if request.endpoint == 'categories' }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-layer-group text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Classes</span>
                </a>
                <div class="pt-8 pb-2 px-4 uppercase text-[9px] font-black text-zinc-600 tracking-[0.3em]">Management
                </div>
                <a href="/teams"
                    class="sidebar-link {{ 'active' if request.endpoint in ['teams', 'manage_team'] }} flex items-center gap-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-users text-sm"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Engineering Teams</span>
                </a>
            </nav>

            <div class="p-6">
                <div
                    class="flex items-center justify-between gap-3 p-3 bg-[var(--bg-alt)] rounded-xl border border-[var(--border-main)]">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div
                            class="w-8 h-8 rounded bg-[var(--logo-bg)] text-[var(--logo-text)] flex items-center justify-center text-[10px] font-black italic">
                            {{ current_user.name[:1] }}
                        </div>
                        <div class="overflow-hidden">
                            <p
                                class="text-[10px] font-black text-[var(--text-primary)] uppercase tracking-tight truncate">
                                {{ current_user.name }}</p>
                            <p class="text-[8px] font-bold text-[var(--text-secondary)] uppercase truncate">{{
                                current_user.role }}</p>
                        </div>
                    </div>
                    <a href="/logout"
                        class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <i class="fas fa-power-off text-xs"></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-[var(--text-secondary)]">{% block
                    title %}{% endblock %}</h2>
                <div class="flex items-center gap-6">
                    <form action="/equipment" method="GET" class="relative">
                        <i
                            class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] text-[10px]"></i>
                        <input type="text" name="q" placeholder="SEARCH SYSTEM..."
                            value="{{ search_query if search_query else '' }}"
                            class="rounded-full pl-9 pr-4 py-1.5 text-[10px] font-bold uppercase tracking-widest transition-all w-48 focus:w-64">
                    </form>

                    <div class="flex items-center gap-3">
                        <button id="theme-toggle"
                            class="w-9 h-9 rounded-full flex items-center justify-center border border-[var(--border-main)] hover:bg-[var(--bg-alt)] transition-all">
                            <i class="fas fa-moon text-xs dark-icon"></i>
                            <i class="fas fa-sun text-xs light-icon hidden"></i>
                        </button>

                        <div class="relative">
                            <button id="notif-btn"
                                class="w-9 h-9 rounded-full flex items-center justify-center border border-[var(--border-main)] hover:bg-[var(--bg-alt)] transition-all relative">
                                <i class="far fa-bell text-xs"></i>
                                <span id="notif-badge"
                                    class="hidden absolute top-2.5 right-2.5 w-1.5 h-1.5 bg-red-600 rounded-full"></span>
                            </button>

                            <!-- Notifications Dropdown -->
                            <div id="notif-dropdown"
                                class="hidden absolute right-0 mt-4 w-80 glass-card rounded-2xl shadow-2xl overflow-hidden z-50">
                                <div
                                    class="p-4 border-b border-[var(--border-main)] flex justify-between items-center bg-[var(--bg-alt)]">
                                    <h4 class="font-black text-[10px] uppercase tracking-widest">Alerts</h4>
                                    <button id="mark-read-btn"
                                        class="text-[8px] font-black uppercase text-zinc-500 hover:text-[var(--text-primary)] tracking-widest transition-colors">Clear
                                        All</button>
                                </div>
                                <div id="notif-list"
                                    class="max-h-96 overflow-y-auto divide-y divide-[var(--border-main)]">
                                    <div
                                        class="p-8 text-center text-zinc-600 text-[10px] font-bold uppercase tracking-widest">
                                        No active transmissions
                                    </div>
                                </div>
                            </div>
                        </div>

                        <a href="/equipment/new"
                            class="w-9 h-9 rounded-full flex items-center justify-center bg-[var(--logo-bg)] text-[var(--logo-text)] hover:opacity-80 transition-all">
                            <i class="fas fa-plus text-xs"></i>
                        </a>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-12">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script>
        // Theme Logic
        const themeBtn = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const darkIcon = document.querySelector('.dark-icon');
        const lightIcon = document.querySelector('.light-icon');

        function setTheme(theme) {
            if (theme === 'light') {
                root.classList.add('light-mode');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                root.classList.remove('light-mode');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        themeBtn.addEventListener('click', () => {
            const isLight = root.classList.contains('light-mode');
            setTheme(isLight ? 'dark' : 'light');
        });

        // Load Initial Theme
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
        setTheme(savedTheme);

        // Notification Logic
        const notifBtn = document.getElementById('notif-btn');
        const notifDropdown = document.getElementById('notif-dropdown');
        const notifList = document.getElementById('notif-list');
        const notifBadge = document.getElementById('notif-badge');
        const markReadBtn = document.getElementById('mark-read-btn');

        async function fetchNotifications() {
            try {
                const resp = await fetch('/api/notifications');
                const notifs = await resp.json();

                if (notifs.length > 0) {
                    const hasUnread = notifs.some(n => !n.is_read);
                    notifBadge.classList.toggle('hidden', !hasUnread);

                    notifList.innerHTML = notifs.map(n => `
                        <div class="p-5 hover:bg-[var(--bg-alt)] transition-colors cursor-pointer ${n.is_read ? 'opacity-40' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-black text-[10px] uppercase tracking-tight text-[var(--text-primary)]">${n.title}</h5>
                                <span class="text-[8px] font-black text-[var(--text-secondary)] italic">${n.created_at}</span>
                            </div>
                            <p class="text-[10px] font-bold text-[var(--text-secondary)] leading-relaxed uppercase tracking-tighter">${n.message}</p>
                        </div>
                    `).join('');
                } else {
                    notifList.innerHTML = '<div class="p-8 text-center text-[var(--text-secondary)] text-[10px] font-bold uppercase tracking-widest">No active transmissions</div>';
                    notifBadge.classList.add('hidden');
                }
            } catch (err) {
                console.error(err);
            }
        }

        notifBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notifDropdown.classList.toggle('hidden');
            fetchNotifications();
        });

        markReadBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await fetch('/api/notifications/mark-read', { method: 'POST' });
            fetchNotifications();
        });

        document.addEventListener('click', () => notifDropdown.classList.add('hidden'));
        notifDropdown.addEventListener('click', e => e.stopPropagation());

        fetchNotifications();
        setInterval(fetchNotifications, 30000);
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>